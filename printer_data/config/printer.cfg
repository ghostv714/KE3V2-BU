# This file contains common pin mappings for the BIGTREETECH Manta E3EZ
# To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" "8 MHz crystal"
# and "USB (on PA11/PA12)" or "CAN bus (on PB12/PB13)".

# See docs/Config_Reference.md for a description of parameters.

########################################
# Slicer_Settings
########################################

[gcode_arcs]
resolution: 0.1
[exclude_object]

[virtual_sdcard]
path: ~/gcode_files

[display_status]


[pause_resume]

########################################
# Included_Configs
########################################


[include START_PRINT.cfg]
[include END_PRINT.cfg]
[include MACROS_0.cfg]
[include GET_PROBE_LIMITS.cfg]


########################################
# MCU
########################################

[mcu]
#####serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_hurakan-if00
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_290020000B504B5735313920-if00

restart_method: command

[virtual_sdcard]
path: /home/biqu/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

########################################
# MCU_Temps
########################################

# [temperature_sensor EZ_E3]
# sensor_type: temperature_mcu
# sensor_mcu: mcu

# [temperature_sensor CB1]
# sensor_type: temperature_host
# sensor_path: /sys/class/thermal/thermal_zone0/temp


########################################
# Stepper_Config
########################################

[stepper_x]
step_pin: PA14
dir_pin: !PA10
enable_pin: !PA13
microsteps: 16
rotation_distance: 40
endstop_pin: ^PC4
position_min: -2
position_endstop: -2
position_max: 258               ###gotta find max 
homing_speed: 150

[stepper_y]
step_pin: PC8
dir_pin: !PA15
enable_pin: !PC14
microsteps: 16
rotation_distance: 40
endstop_pin: ^PB0
position_min: -26
position_endstop: -26
position_max: 224
homing_speed: 150

[stepper_z]
step_pin: PD2
dir_pin: !PD4
enable_pin: !PD3
microsteps: 16
rotation_distance: 8
#endstop_pin: ^PC6
endstop_pin: probe:z_virtual_endstop
position_max: 246.6
position_min: -20

########################################
# TMC2209 configuration
########################################

[tmc2209 stepper_x]
uart_pin: PB8
##diag_pin: PC4
hold_current: 0.600
run_current: 0.650
#stealthchop_threshold: 999999

[tmc2209 stepper_y]
uart_pin: PC9
##diag_pin: PB0
hold_current: 0.600
run_current: 0.650
#stealthchop_threshold: 999999

[tmc2209 stepper_z]
uart_pin: PD0
##diag_pin: PC6
hold_current: 0.600
run_current: 0.650
#stealthchop_threshold: 999999

[tmc2209 extruder]
uart_pin: PD1
hold_current: 0.500
run_current: 0.600
#stealthchop_threshold: 999999

#[tmc2209 extruder1]
#uart_pin: PB5
#run_current: 0.800
#stealthchop_threshold: 999999


########################################
# Heaters
########################################

[extruder]
step_pin: PD5
dir_pin: !PD6
enable_pin: !PB3
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 53.087649466624
# rotation_distance: 53.494165  
gear_ratio: 44:10, 37:17
nozzle_diameter: 0.400
filament_diameter: 1.650
heater_pin: PB11 #HE0
# sensor_type: ATC Semitec 104NT-4-R025H42G  ## CHC aliexress hotend##
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PA4 #TH0
control: pid
pid_Kp=17.401
pid_Ki=1.813
pid_Kd=41.763
min_temp: 0
max_temp: 300
# pressure_advance: 0.076  #previous PA 0.4mm nozzle
# pressure_advance: 0.015    #New PA for 0.6mm nozzle
pressure_advance: 0.082    
max_extrude_only_distance: 1000.0
max_extrude_only_velocity: 200.0
max_extrude_only_accel: 1500
max_extrude_cross_section: 5

[heater_bed]
heater_pin: PB2 #HB
sensor_type: EPCOS 100K B57560G104F #Generic 3950
sensor_pin: PA3 #TB
control: watermark
min_temp: 0
max_temp: 130

# [temperature_sensor chamber]
# sensor_type:ATC Semitec 104NT-4-R025H42G
# sensor_pin: PA5
# min_temp:0
# max_temp:80


[heater_generic chamber]
#gcode_id:
#   The id to use when reporting the temperature in the M105 command.
#   This parameter must be provided.
heater_pin:PB10
#max_power:
sensor_type:ATC Semitec 104NT-4-R025H42G
sensor_pin:PA5
#smooth_time:
control: pid
pid_Kp=17.401
pid_Ki=1.813
pid_Kd=41.763
#pwm_cycle_time:
min_temp:0
max_temp:250
#   See the "extruder" section for the definition of the above
#   parameters.
########################################
# Fans
########################################

[fan]
pin: PA8
max_power: 1.0

[heater_fan Extruder]
pin: PB15
heater: extruder
max_power: 1.0
fan_speed: 1.0
heater_temp: 60.0

[temperature_fan CB1]
sensor_type: temperature_host
sensor_path: /sys/class/thermal/thermal_zone0/temp
pin: PB14
control: pid
kick_start_time: 0.9
max_speed: 1.0
min_speed: 0.6
shutdown_speed: 0
target_temp: 40.0
min_temp:0
max_temp:80
pid_Kp:1
pid_Ki:0.5
pid_Kd:2.0
pid_deriv_time: 2.0



########################################
# CR_Touch Settings
########################################

[probe]
pin: ^PC6 #Change to where you plug your probe in, endstop or probe pin pulled high (^)
#z_offset: -6.3 #Measure per your specific setup. Klipper will NOT save this value if this in not located in printer.cfg
x_offset: 4 # negative = left of the nozzle
y_offset: 21 # negative = in front of of the nozzle
speed: 50.0
lift_speed: 50.0
sample_retract_dist: 1
samples: 2
samples_tolerance_retries: 6


[homing_override]
set_position_z:0 # Make printer think Z axis is at zero, so we can force a move upwards away from build plate
axes: z #will only call override if x is involved in the homing call
gcode:
  G90
  G1 Z5 F3000 ; move up to prevent accidentally scratching build plate    
  {% if "x" not in (printer.toolhead.homed_axes | lower) %}
      G28 X
  {% endif %}
  {% if "y" not in (printer.toolhead.homed_axes | lower) %}
      G28 Y        #Will only home XY if they are not currently homed
  {% endif %}
  PROBE_OUT
  G1 X113.5 Y96.5 F6000 ; Adjusted for normal klack offsets with a 235x235 bed X: 117.5 - x_offset, Y: 117.5 - y_offset
  G28 Z
  PROBE_IN

##[(7x7)-1] / 2 = 24
##[(5x5)-1] / 2 = 12
[bed_mesh]
speed: 300
horizontal_move_z: 10 #Positive value equal to z_offset or larger. eg: if z_offset is -2.5 this must be at least 2.5 or larger
mesh_min: 2,3
mesh_max: 223,201
probe_count: 5,5
adaptive_margin: 3
zero_reference_position: 117.5, 117.5 #for 235x235 bed. adapt to your bed size if needed. same for mesh min and max above
algorithm: bicubic
fade_start: 1
fade_end: 10
#fade_target:
#   The z position in which fade should converge. When this value is set
#   to a non-zero value it must be within the range of z-values in the mesh.
#   Users that wish to converge to the z homing position should set this to 0.
#   Default is the average z value of the mesh.
split_delta_z: 0.015
#   The amount of Z difference (in mm) along a move that will
#   trigger a split. Default is .025.
move_check_distance: 3
#   The distance (in mm) along a move to check for split_delta_z.
#   This is also the minimum length that a move can be split. Default
#   is 5.0.
mesh_pps: 4,4
#   A comma separated pair of integers (X,Y) defining the number of
#   points per segment to interpolate in the mesh along each axis. A
#   "segment" can be defined as the space between each probed
#   point. The user may enter a single value which will be applied
#   to both axes.  Default is 2,2.
#bicubic_tension: .2
#   When using the bicubic algorithm the tension parameter above
#   may be applied to change the amount of slope interpolated.
#   Larger numbers will increase the amount of slope, which
#   results in more curvature in the mesh. Default is .2.

[screws_tilt_adjust] #Change to your specific printer is needed. Back left screw as referance point and that's where strain relief is is recommended
screw1: 28.5, 181.5
screw1_name: Back left
screw2: 28.5, 11.5
screw2_name: Front left
screw3: 198.5, 11.5
screw3_name: Front right
screw4: 198.5, 181.5
screw4_name: Back right
screw_thread: CW-M4 #Ender 3s use CW-M4 change for your printer if needed
horizontal_move_z: 10
# To calculate the position of your screws:
# Screw Offsets: 32.5mm for ender 3 beds
# Default Klack probe offsets: X: 4, Y: 21
#Back left	
#   X: 0 + screw_x_offset - probe.x_offset	
#   Y: 235 - screw_y_offset - probe.y_offset
#Front left	
#   X: 0 + screw_x_offset - probe.x_offset	
#   Y: 0 + screw_y_offset - probe.y_offset
#Front right 
#   X: 235 - screw_x_offset - probe.x_offset	
#   Y: 0 + screw_y_offset - probe.y_offset
#Back right	
#   X: 235 - screw_x_offset - probe.x_offset	
#   Y: 235 - screw_y_offset - probe.y_offset
# x and y offsets are usually the same. You will have to find info on your printer or measure them yourself
# This can be adapted for three screw bed as well without eny problem. In that case X offset of the third screw would be build volume divided by 2




########################################
# Input_Shaper
########################################

[input_shaper]
shaper_freq_x: 36.8
shaper_type_x: mzv
shaper_freq_y: 29.4
shaper_type_y: mzv
#shaper_freq_x: 66.66  # frequency for the X mark of the test model
#shaper_freq_y: 60.70  # frequency for the Y mark of the test model
damping_ratio_x: 0.52
damping_ratio_y: 0.49

[printer]
kinematics: cartesian
max_velocity: 1500
max_accel: 3500
max_z_velocity: 4
max_z_accel: 200
square_corner_velocity: 5.0

########################################
# Firmware Retract
########################################


[firmware_retraction]
retract_length: 0.10
#   The length of filament (in mm) to retract when G10 is activated,
#   and to unretract when G11 is activated (but see
#   unretract_extra_length below). The default is 0 mm.
retract_speed: 60
#   The speed of retraction, in mm/s. The default is 20 mm/s.
unretract_extra_length: 0
#   The length (in mm) of *additional* filament to add when
#   unretracting.
unretract_speed: 40
#   The speed of unretraction, in mm/s. The default is 10 mm/s.


########################################
# NeoPixles
########################################

[neopixel th_leds]
pin:          PC7
chain_count:  7
color_order: GRB
initial_RED: 1.0
initial_GREEN: 1.0
initial_BLUE: 1.0

########################################
# Filament_Sensor
########################################

# [filament_switch_sensor ro1]
# switch_pin: !PC5
# pause_on_runout: True


#[filament_switch_sensor material_1]
#switch_pin: PB1

########################################
# Add_Ons (BTT Specific)
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PC1, EXP1_3=PC3, EXP1_5=PC0, EXP1_7=PA2, EXP1_9=<GND>,
    EXP1_2=PC2,  EXP1_4=<RST>, EXP1_6=PA0, EXP1_8=PA1, EXP1_10=<5V>

#[output_pin PS_ON]
#pin: PA9

#[output_pin pb9_pin]
#pin: PB9

########################################
# Klack-Ender macros
########################################

[gcode_macro SCREWS_TILT_CALCULATE]
rename_existing: _SCREWS_TILT_CALCULATE
gcode:
  G28 ; Should always home before calculation even if already homed
  probe_out
  _SCREWS_TILT_CALCULATE
  probe_in


#####################################################################
# KlackEnder- Macros
#####################################################################

[gcode_macro PROBE_OUT]
gcode:
  G90
  G1 X246.6 F4000
  G4 P300
  G1 Z15
  G1 X0

[gcode_macro PROBE_IN]
gcode:
  G90
  G1 Z20
  G1 X246.6 F12000
  G1 Y0 ; Check this against your config of [stepper_y] position_min: ...!
  G1 Z0
  G4 P300
  G1 X220 F6000
  G1 Z10
  G1 X0

[gcode_macro BED_MESH_CALIBRATE] #macro with parameter passing
rename_existing: _BED_MESH_CALIBRATE
gcode:
  PROBE_OUT
  _BED_MESH_CALIBRATE {rawparams}
  PROBE_IN

[gcode_macro G29] #reliant on the macro above
gcode:
  BED_MESH_CALIBRATE

[gcode_macro PROBE_CALIBRATE]
rename_existing: _PROBE_CALIBRATE
gcode:
  {% if not 'xyz' in printer.toolhead.homed_axes %}
  G28
  {% endif %}
  PROBE_OUT
  G90
  G1 Z20
  G1 X113.5 Y96.5 F12000 ; Readjust for center of bed adjusted for probe offset
  _PROBE_CALIBRATE
  TESTZ Z=10
  M117 Remove the Klack to continue calibration!

[gcode_macro PROBE_ACCURACY]
rename_existing: _PROBE_ACCURACY
gcode:
  {% if not 'xyz' in printer.toolhead.homed_axes %}
  G28
  {% endif %}
  PROBE_OUT
  G90
  G1 X113.5 Y96.5 F12000 ; Readjust for center of bed adjusted for probe offset
  _PROBE_ACCURACY
  PROBE_IN

[include moonraker_obico_macros.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 6.169
